name: Build OBS ShaderFilter Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  PLUGIN_NAME: obs-shaderfilter-step
  OBS_VERSION: "30.0.2"

jobs:
  linux:
    name: Linux Ubuntu ${{ matrix.version }}
    runs-on: ubuntu-${{ matrix.version }}
    strategy:
      fail-fast: false
      matrix:
        version: ['20.04', '22.04']
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libobs-dev \
            libfftw3-dev \
            obs-studio
            
      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON
            
      - name: Build
        run: |
          cd build
          ninja
          
      - name: Package
        run: |
          cd build
          mkdir -p package/obs-plugins/64bit
          mkdir -p package/data/obs-plugins/${{ env.PLUGIN_NAME }}
          
          # Copy built plugin
          cp ${{ env.PLUGIN_NAME }}.so package/obs-plugins/64bit/
          
          # Copy data files
          if [ -d "../data" ]; then
            cp -r ../data/* package/data/obs-plugins/${{ env.PLUGIN_NAME }}/
          fi
          
          # Create tarball
          tar -czf ${{ env.PLUGIN_NAME }}-ubuntu-${{ matrix.version }}.tar.gz -C package .
          
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-ubuntu-${{ matrix.version }}
          path: build/*.tar.gz